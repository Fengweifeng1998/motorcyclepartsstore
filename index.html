<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>摩托车配件商城</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <header>
    <h1>摩托车配件商城</h1>
  </header>

  <main>
    <div class="filters">
      <div class="filter-group">
        <label>按车型筛选：</label>
        <div class="filter-buttons">
          <button class="filter-btn" data-filter="model" data-value="">全部车型</button>
          <button class="filter-btn" data-filter="model" data-value="CG125">CG125</button>
          <button class="filter-btn" data-filter="model" data-value="GN125">GN125</button>
          <button class="filter-btn" data-filter="model" data-value="CD110">CD110</button>
          <button class="filter-btn" data-filter="model" data-value="Bajaj100">Bajaj100</button>
          <button class="filter-btn" data-filter="model" data-value="TVS Star">TVS Star</button>
          <button class="filter-btn" data-filter="model" data-value="TVS HLX">TVS HLX</button>
          <button class="filter-btn" data-filter="model" data-value="WY125">WY125</button>
          <button class="filter-btn" data-filter="model" data-value="CGL125">CGL125</button>
        </div>
      </div>

      <div class="filter-group">
        <label>按部位筛选：</label>
        <div class="filter-buttons">
          <button class="filter-btn" data-filter="part" data-value="">全部部位</button>
          <button class="filter-btn" data-filter="part" data-value="传动系统">传动系统</button>
          <button class="filter-btn" data-filter="part" data-value="制动系统">制动系统</button>
          <button class="filter-btn" data-filter="part" data-value="行驶系统">行驶系统</button>
          <button class="filter-btn" data-filter="part" data-value="轮胎">轮胎</button>
          <button class="filter-btn" data-filter="part" data-value="发动机部件">发动机部件</button>
          <button class="filter-btn" data-filter="part" data-value="滤清器">滤清器</button>
          <button class="filter-btn" data-filter="part" data-value="电气系统">电气系统</button>
          <button class="filter-btn" data-filter="part" data-value="车身配件">车身配件</button>
        </div>
      </div>
    </div>

    <div class="reset-section">
      <button id="reset-filters" class="reset-btn">重置筛选</button>
    </div>

    <div id="product-list" class="product-grid">
      <p>正在从 Google Sheets 加载产品数据...</p>
    </div>
  </main>

  <footer>
    <p>&copy; 2024 摩托车配件商城</p>
  </footer>

  <script>
    let allProducts = [];
    let currentModelFilter = '';
    let currentPartFilter = '';
    
    // =======================================================
    // 谷歌表格 API 配置
    // =======================================================
    const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/2PACX-1vTJU5sgOoD5tKC4PInPBE6s7Bil5MFkV4xTGAg_q-sjnNFcX31Jca0zyih8jBU2dpdujAkUpwF31NGQ/gviz/tq?tqx=out:json&tq&gid=0';

    // =======================================================
    // 1. 数据获取主函数 (取代了原来的 fetch('products.json'))
    // =======================================================
    async function fetchProducts() {
        const container = document.getElementById('product-list');
        container.innerHTML = '<p>正在加载...</p>';

        try {
            const response = await fetch(SHEET_DATA_URL);
            const text = await response.text();
            
            // 清理 Google Visualization API 返回的 JSON 文本
            const jsonString = text.substring(47).slice(0, -2); 
            const data = JSON.parse(jsonString);
            
            // 转换为产品数组，并赋值给全局变量
            allProducts = transformSheetData(data);
            
            // 渲染产品列表
            renderProducts(allProducts); 

        } catch (error) {
            console.error('加载 Google Sheets 数据失败:', error);
            container.innerHTML = '<p style="color: red;">抱歉，加载产品数据失败。请检查 Google Sheets 是否已发布。</p>';
        }
    }

    // =======================================================
    // 2. A 到 S 列结构定制的转换函数 (精确映射到旧的 JS 键名)
    // =======================================================
    function transformSheetData(sheetData) {
        const rows = sheetData.table.rows;   
        
        // 过滤掉标题行 (假设 B 列是标题“名称”) 和空行
        const filteredRows = rows.filter(row => {
            const name = row.c[1] && row.c[1].v !== undefined ? row.c[1].v : null;
            return name && name !== '名称';
        });

        const productArray = filteredRows.map(row => {
            // 检查 row.c[i] 是否存在，并优先使用 .v (值) 或 .f (格式化值)
            const getVal = (index) => row.c[index] ? (row.c[index].v || row.c[index].f) : null;
            const product = {};
            
            // --- 映射到旧 JS 的键名 ---
            
            // A 列: 商品 ID -> p.id (用于图片切换)
            product.id = getVal(0); 
            
            // B 列: 名称 -> p.name
            product.name = getVal(1);
            
            // C 列: 部位类型 -> p.part (用于筛选)
            product.part = getVal(2);

            // D 列: 车型 -> p.models (数组, 用于筛选)
            // 你的筛选逻辑需要 p.models 是一个数组，即使只有一个车型
            const modelVal = getVal(3);
            product.models = modelVal ? [modelVal] : []; 
            
            // E 到 J 列: 规格信息
            product.size = getVal(4);      // E 列: 尺寸
            product.weight = getVal(5);    // F 列: 重量
            product.price = getVal(6) ? parseFloat(getVal(6)) : 0; // G 列: 价格
            product.packaging = getVal(7); // H 列: 包装方式
            product.quantity_per_box = getVal(8) ? parseInt(getVal(8)) : null; // I 列: 每箱数量
            product.min_order_qty = getVal(9) ? parseInt(getVal(9)) : 1; // J 列: 起订量

            // K 到 N 列: 描述和状态
            product.description_main = getVal(10); // K 列: 描述 (新键名，避免冲突)
            product.description = getVal(11); // L 列: 其他描述 -> 映射到 p.description (旧 JS 使用)
            product.status = getVal(12);    // M 列: 状态
            product.notes = getVal(13);     // N 列: 备注
            
            // O 到 S 列: 图片链接 -> 映射到 p.images 数组结构 (旧 JS 使用)
            product.images = [];
            for(let i = 14; i <= 18; i++) {
                const url = getVal(i);
                if (url) {
                    // 我们假设图片没有 caption
                    product.images.push({ url: url, caption: null });
                }
            }
            if (product.images.length === 0) {
                 product.images.push({ url: 'images/placeholder.jpg', caption: null });
            }

            return product;
        });

        return productArray; 
    }

    // 启动数据加载流程
    fetchProducts(); 
  </script>

  <script>
    // 1. 渲染产品列表
    function renderProducts(products) {
      const container = document.getElementById('product-list');
      container.innerHTML = products.map(p => {
        // 默认主图
        const mainImage = (p.images && p.images[0]) ? p.images[0].url : 'images/placeholder.jpg';
        const mainImageCaption = (p.images && p.images[0]) ? p.images[0].caption || '' : '';

        // 附图缩略图
        const thumbnails = (p.images && p.images.slice(1)) ? p.images.slice(1).map(img => `
          <div class="thumb-container">
            <img src="${img.url}" class="thumb" alt="附图" onclick="swapImage(this, '${p.id}')">
            ${img.caption ? `<p class="thumb-caption">${img.caption}</p>` : ''}
          </div>
        `).join('') : '';

        // 产品信息
        const details = `
          <p><strong>型号:</strong> ${p.models.join(', ') || 'N/A'}</p>
          <p><strong>尺寸:</strong> ${p.size || 'N/A'}</p>
          <p><strong>重量:</strong> ${p.weight || 'N/A'}</p>
          <p><strong>包装:</strong> ${p.packaging || 'N/A'}</p>
          <p><strong>每箱数量:</strong> ${p.quantity_per_box || 'N/A'}</p>
          <p><strong>价格:</strong> ¥${p.price.toFixed(2)}</p>
          <p><strong>起订量:</strong> ${p.min_order_qty || 'N/A'}</p>
          <p><strong>其他描述:</strong> ${p.description || 'N/A'}</p>
        `;

        return `
          <div class="product" data-models="${p.models.join(', ')}" data-part="${p.part}">
            <div class="image-section">
              <img src="${mainImage}" class="main-image" id="main-${p.id}" alt="${p.name}">
              ${mainImageCaption ? `<p class="main-caption">${mainImageCaption}</p>` : ''}
              <div class="thumbnails">
                ${thumbnails}
              </div>
            </div>
            <div class="info-section">
              <h3>${p.name}</h3>
              ${details}
            </div>
          </div>
        `;
      }).join('');
      
      // 如果没有产品，显示提示
      if (products.length === 0 && container.innerHTML === '') {
          container.innerHTML = '<p>没有找到符合条件的产品。</p>';
      }
    }

    // 2. 筛选逻辑 (使用事件代理监听点击)
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filterType = btn.getAttribute('data-filter');
        const filterValue = btn.getAttribute('data-value');

        if (filterType === 'model') {
          currentModelFilter = filterValue;
        } else if (filterType === 'part') {
          currentPartFilter = filterValue;
        }

        // 更新按钮选中状态
        document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 应用筛选
        applyFilters();
      });
    });

    // 3. 应用筛选
    function applyFilters() {
      const filtered = allProducts.filter(p => {
        // 车型筛选：检查产品的 p.models 数组是否包含当前筛选值，或者当前筛选值为空
        const matchesModel = currentModelFilter === '' || p.models.includes(currentModelFilter);
        // 部位筛选：检查 p.part 是否等于当前筛选值，或者当前筛选值为空
        const matchesPart = currentPartFilter === '' || p.part === currentPartFilter;
        return matchesModel && matchesPart;
      });
      renderProducts(filtered);
    }

    // 4. 重置筛选
    document.getElementById('reset-filters').addEventListener('click', () => {
      currentModelFilter = '';
      currentPartFilter = '';
      // 重置按钮的 active 状态
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.filter-btn[data-filter="model"][data-value=""]').classList.add('active'); 
      document.querySelector('.filter-btn[data-filter="part"][data-value=""]').classList.add('active'); 
      
      renderProducts(allProducts);
    });

    // 5. 切换主图
    function swapImage(thumb, productId) {
      const newSrc = thumb.src;
      // 确保找到对应 ID 的主图
      const mainImageElement = document.getElementById(`main-${productId}`);
      if (mainImageElement) {
         mainImageElement.src = newSrc;
      }
    }
  </script>

</body>
</html>
