<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>摩托车配件商城</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <header>
    <h1>摩托车配件商城</h1>
  </header>

  <main>
    <div class="filters">
      <div class="filter-group">
        <label>按车型筛选：</label>
        <div class="filter-buttons" id="model-filters">
          <button class="filter-btn active" data-filter="model" data-value="">全部车型</button>
          <button class="filter-btn" data-filter="model" data-value="CG125">CG125</button>
          <button class="filter-btn" data-filter="model" data-value="GN125">GN125</button>
          <button class="filter-btn" data-filter="model" data-value="CD110">CD110</button>
          <button class="filter-btn" data-filter="model" data-value="Bajaj100">Bajaj100</button>
          <button class="filter-btn" data-filter="model" data-value="TVS Star">TVS Star</button>
          <button class="filter-btn" data-filter="model" data-value="TVS HLX">TVS HLX</button>
          <button class="filter-btn" data-filter="model" data-value="WY125">WY125</button>
          <button class="filter-btn" data-filter="model" data-value="CGL125">CGL125</button>
        </div>
      </div>

      <div class="filter-group">
        <label>按部位筛选：</label>
        <div class="filter-buttons" id="part-filters">
          <button class="filter-btn active" data-filter="part" data-value="">全部部位</button>
        </div>
      </div>
    </div>

    <div class="reset-section">
      <button id="reset-filters" class="reset-btn">重置筛选</button>
    </div>

    <div id="product-list" class="product-grid">
      <p>正在从 Google Sheets 加载产品数据...</p>
    </div>
  </main>

  <footer>
    <p>&copy; 2024 摩托车配件商城</p>
  </footer>

  <script>
    let allProducts = [];
    let currentModelFilter = '';
    let currentPartFilter = '';
    
    // =======================================================
    // 谷歌表格 API 配置 - 使用 Document ID
    // =======================================================
    const SHEET_DATA_URL = 'https://docs.google.com/spreadsheets/d/1_20vmfXJly3oPTEIMdSAPWy8bcUxi2pn__hcAF7gA3Q/gviz/tq?tqx=out:json&tq&gid=0';
    
    // 辅助函数：安全获取单元格的值并清理空格 (修复筛选的关键)
    const getTrimmedVal = (row, index) => {
        const cell = row.c[index];
        if (!cell) return null;
        let rawVal = cell.v || cell.f;
        if (typeof rawVal === 'string') {
            return rawVal.trim(); 
        }
        return rawVal;
    };

    // =======================================================
    // 1. 数据获取主函数 
    // =======================================================
    async function fetchProducts() {
        const container = document.getElementById('product-list');
        container.innerHTML = '<p>正在加载...</p>';

        try {
            const response = await fetch(SHEET_DATA_URL);
            const text = await response.text();
            
            // 清理 Google Visualization API 返回的 JSON 文本
            const jsonString = text.substring(47).slice(0, -2); 
            const data = JSON.parse(jsonString);
            
            // 转换为产品数组，并赋值给全局变量
            allProducts = transformSheetData(data);
            
            // !!! 核心改进：动态生成筛选按钮 !!!
            renderFilters(allProducts); 
            
            // 绑定所有筛选按钮事件 (包括静态和动态生成的)
            bindFilterEvents();
            
            // 渲染产品列表
            renderProducts(allProducts); 

        } catch (error) {
            console.error('加载 Google Sheets 数据失败:', error);
            container.innerHTML = '<p style="color: red;">抱歉，加载产品数据失败。请检查 Google Sheets 是否已发布。</p>';
        }
    }

    // =======================================================
    // 2. A 到 S 列结构定制的转换函数 (包含 .trim() 修复)
    // =======================================================
    function transformSheetData(sheetData) {
        const rows = sheetData.table.rows;   
        
        // 过滤掉标题行 (假设 B 列是标题“名称”) 和空行
        const filteredRows = rows.filter(row => {
            const name = getTrimmedVal(row, 1);
            return name && name !== '名称';
        });

        const productArray = filteredRows.map(row => {
            const product = {};
            
            // C 列: 部位类型 -> p.part (用于筛选，已清理)
            product.part = getTrimmedVal(row, 2);

            // D 列: 车型 -> p.models (数组, 用于筛选，已清理)
            const modelVal = getTrimmedVal(row, 3);
            product.models = modelVal ? [modelVal] : []; 
            
            // ... (其它 16 个字段的映射保持不变)
            product.id = getTrimmedVal(row, 0); 
            product.name = getTrimmedVal(row, 1);
            product.size = getTrimmedVal(row, 4);      
            product.weight = getTrimmedVal(row, 5);    
            product.price = getTrimmedVal(row, 6) ? parseFloat(getTrimmedVal(row, 6)) : 0; 
            product.packaging = getTrimmedVal(row, 7); 
            product.quantity_per_box = getTrimmedVal(row, 8) ? parseInt(getTrimmedVal(row, 8)) : null; 
            product.min_order_qty = getTrimmedVal(row, 9) ? parseInt(getTrimmedVal(row, 9)) : 1; 
            product.description_main = getTrimmedVal(row, 10); 
            product.description = getTrimmedVal(row, 11); 
            product.status = getTrimmedVal(row, 12);    
            product.notes = getTrimmedVal(row, 13);     
            
            // O 到 S 列: 图片链接 -> 映射到 p.images 数组结构 
            product.images = [];
            for(let i = 14; i <= 18; i++) {
                const url = getTrimmedVal(row, i);
                if (url) {
                    product.images.push({ url: url, caption: null });
                }
            }
            if (product.images.length === 0) {
                 product.images.push({ url: 'images/placeholder.jpg', caption: null });
            }

            return product;
        });

        return productArray; 
    }
    
    // =======================================================
    // 3. 动态生成筛选按钮 (核心改进)
    // =======================================================
    function renderFilters(products) {
        // 收集所有唯一的部位类型 (Set 自动去重)
        const partTypes = new Set();
        products.forEach(p => {
            if (p.part) {
                partTypes.add(p.part);
            }
        });
        
        const partFilterContainer = document.getElementById('part-filters');
        
        // 1. 保留“全部部位”按钮
        const allPartsButton = partFilterContainer.querySelector('.filter-btn[data-filter="part"][data-value=""]');
        partFilterContainer.innerHTML = '';
        if (allPartsButton) {
            partFilterContainer.appendChild(allPartsButton);
        }
        
        // 2. 生成动态按钮
        partTypes.forEach(part => {
            const button = document.createElement('button');
            button.className = 'filter-btn';
            button.setAttribute('data-filter', 'part');
            button.setAttribute('data-value', part);
            button.textContent = part;
            
            partFilterContainer.appendChild(button);
        });
    }

    // =======================================================
    // 4. 统一绑定所有筛选按钮事件 (适用于静态和动态生成的按钮)
    // =======================================================
    function bindFilterEvents() {
        // 移除旧的事件监听器 (避免重复绑定)
        // 注意：由于是动态替换元素内容，这里理论上不需要手动移除，但统一绑定更安全
        
        // 绑定所有 .filter-btn 按钮
        document.querySelectorAll('.filter-btn').forEach(btn => {
            // 先移除可能存在的旧监听器，然后添加新监听器
            btn.removeEventListener('click', handleFilterClick); 
            btn.addEventListener('click', handleFilterClick);
        });
        
        // 初始化时，确保“全部”按钮处于 active 状态
        document.querySelector('.filter-btn[data-filter="model"][data-value=""]').classList.add('active');
        document.querySelector('.filter-btn[data-filter="part"][data-value=""]').classList.add('active');
    }
    
    // 5. 核心事件处理函数
    function handleFilterClick() {
        const btn = this; 
        const filterType = btn.getAttribute('data-filter');
        const filterValue = btn.getAttribute('data-value');

        if (filterType === 'model') {
            currentModelFilter = filterValue;
        } else if (filterType === 'part') {
            currentPartFilter = filterValue;
        }

        // 更新按钮选中状态
        document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 应用筛选
        applyFilters();
    }


    // 6. 应用筛选
    function applyFilters() {
      const filtered = allProducts.filter(p => {
        // 筛选逻辑依赖于 transformSheetData 中 p.models 和 p.part 的准确性
        const matchesModel = currentModelFilter === '' || p.models.includes(currentModelFilter);
        const matchesPart = currentPartFilter === '' || p.part === currentPartFilter;
        return matchesModel && matchesPart;
      });
      renderProducts(filtered);
    }

    // 7. 重置筛选
    document.getElementById('reset-filters').addEventListener('click', () => {
      currentModelFilter = '';
      currentPartFilter = '';
      
      // 重置按钮的 active 状态
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.filter-btn[data-filter="model"][data-value=""]').classList.add('active'); 
      document.querySelector('.filter-btn[data-filter="part"][data-value=""]').classList.add('active'); 
      
      renderProducts(allProducts);
    });
    
    // 8. 渲染产品列表 (与你原来的逻辑保持一致)
    function renderProducts(products) {
      const container = document.getElementById('product-list');
      container.innerHTML = products.map(p => {
        const mainImage = (p.images && p.images[0]) ? p.images[0].url : 'images/placeholder.jpg';
        const mainImageCaption = (p.images && p.images[0]) ? p.images[0].caption || '' : '';

        const thumbnails = (p.images && p.images.slice(1)) ? p.images.slice(1).map(img => `
          <div class="thumb-container">
            <img src="${img.url}" class="thumb" alt="附图" onclick="swapImage(this, '${p.id}')">
            ${img.caption ? `<p class="thumb-caption">${img.caption}</p>` : ''}
          </div>
        `).join('') : '';

        const details = `
          <p><strong>型号:</strong> ${p.models.join(', ') || 'N/A'}</p>
          <p><strong>尺寸:</strong> ${p.size || 'N/A'}</p>
          <p><strong>重量:</strong> ${p.weight || 'N/A'}</p>
          <p><strong>包装:</strong> ${p.packaging || 'N/A'}</p>
          <p><strong>每箱数量:</strong> ${p.quantity_per_box || 'N/A'}</p>
          <p><strong>价格:</strong> ¥${p.price.toFixed(2)}</p>
          <p><strong>起订量:</strong> ${p.min_order_qty || 'N/A'}</p>
          <p><strong>其他描述:</strong> ${p.description || 'N/A'}</p>
        `;

        return `
          <div class="product" data-models="${p.models.join(', ')}" data-part="${p.part}">
            <div class="image-section">
              <img src="${mainImage}" class="main-image" id="main-${p.id}" alt="${p.name}">
              ${mainImageCaption ? `<p class="main-caption">${mainImageCaption}</p>` : ''}
              <div class="thumbnails">
                ${thumbnails}
              </div>
            </div>
            <div class="info-section">
              <h3>${p.name}</h3>
              ${details}
            </div>
          </div>
        `;
      }).join('');
      
      if (products.length === 0 && container.innerHTML === '') {
          container.innerHTML = '<p>没有找到符合条件的产品。</p>';
      }
    }

    // 9. 切换主图
    function swapImage(thumb, productId) {
      const newSrc = thumb.src;
      const mainImageElement = document.getElementById(`main-${productId}`);
      if (mainImageElement) {
         mainImageElement.src = newSrc;
      }
    }


    // 启动数据加载流程
    fetchProducts(); 
  </script>

</body>
</html>
